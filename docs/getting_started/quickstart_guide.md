# Quickstart Guide

## Prerequesites

- A running **cloud.iO services** instance. See the getting started guide: [Deploy cloud hosted infrastructure](/getting_started/deploy).
- Java JDK 11+ installed.

Please, enter your cloud.iO servers **hostname**:
<div class="container">
<table>
      <tr>
         <th>Hostname</th>
      </tr>
      <tr>
         <td><input id="hostname"
            class="form-control" 
            type="text" 
            placeholder="http://127.0.0.1:8080"></td>
      </tr>
   </table>
</div>

## Set the CORS policy

This guide will send HTTP REST commands to your **cloud.iO** server. To allow a webpage to communicate with the **cloud.iO** server, 
you have to set up its **CORS policy** (more information about **CORS** can be found [here](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)).

- Connect to the cloud.iO Swagger UI at 
<body>
	
	<a id="swagger_url" target="_blank" href="your_server_ip:8080/swagger-ui/index.html#/Cors Management/postOrigin">your_server_ip:8080/swagger-ui/index.html#/CorsManagement/postOrigin</a>
</body>
- Click *"Try it out"*, add "\*" in the origin field, then click *"Execute"*:

<p align="center">
  <br>
  <img src="getting_started/_media/cors_1.png" style="width:30%" />
  <br>
</p>

- A login will be asked. Use the **REST API admin login** obtained during the deployement.
- Verify that the server responds with a *204* HTTP code:

<p align="center">
  <br>
  <img src="getting_started/_media/cors_2.png" style="width:40%" />
  <br>
</p>

!> All origins are now accepted. It is recommended to not use this CORS configuration in a production environnement.

Check that everything is correctly set up by testing the connection with the server:

<div class="container">
   <table>
      <tr>
         <th>Username</th>
         <th>Password</th>
      </tr>
      <tr>
         <td><input id="username"
            class="form-control" 
            type="text" 
            placeholder="admin"> </td>
         <td><input id="password"
            class="form-control" 
            type="password" 
            placeholder="password"> </td>
      </tr>
   </table>
   <div class="form-group"> 
      <button id="btn-test"
         class="btn btn-success btn-lg float-right" 
         type="submit"> 
      Test  
      </button> 
   </div>
</div>

!> If you followed the [Deploy cloud hosted infrastructure](/getting_started/deploy) guide, your server is in HTTP. As this web server is secured (HTTPs), 
your browser will probably block the HTTP requests to your cloud.io server (more information about mixed content [here](https://support.mozilla.org/en-US/kb/mixed-content-blocking-firefox)). 
To avoid this, disable the mixed content protection. 

**Disable the mixed content protection:**

In *Firefox*:
- <img src="getting_started/_media/mixed_content_1.png" style="width:30%" />
- <img src="getting_started/_media/mixed_content_2.png" style="width:30%" />
- Retry to connect to the server.

## Get the certificates
A new **endpoint** can now be created and its **certificates** generated by clicking the button below:
<div class="form-group"> 
      <button id="btn-certs"
         class="btn btn-success btn-lg float-right" 
         type="submit"> 
      Get certificates  
      </button> 
</div>

## Run the example endpoint java

This section describes how to run your very first cloud.iO endpoint. This endpoint implements a simple counter that increments its value every 1s.
- **Clone** or **download** the [cloudio-endpoint-java-example](https://github.com/cloudio-project/cloudio-endpoint-java-example) repository.
- To be able to get the [cloudio-endpoint-java](https://github.com/cloudio-project/cloudio-endpoint-java) library, you'll need to fill the *gradle.properties* file with your Github **username** and 
a **personal access token**. Don't know how to generate a github **personal access token**? Go to [the Github documentation](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token).
- Extract the certificates in *cloudio-endpoint-java-example/src/main/resources/cloud.io/*.
- Complete the *clientCert* and *authorityCert* path in *cloudio-endpoint-java-example/src/main/resources/cloud.io/example.properties*.
- Run the demo endpoint<br>Linux:
```bash
./gradlew build
./gradlew run
```
<br>Windows:
```bash
gradlew.bat build
gradlew.bat run
```

You should now see the log *"Endpoint is online"* in the console.

## Read the data
If not done automatically at the previous step, please entre the endpoint **UUID** below. 
Hitting the start button will enable the polling of the attribute *myNode/myObject/myMeasure* value.
<div class="container">
   <table>
      <tr>
         <th>UUID</th>
      </tr>
      <tr>
         <td><input id="uuid"
            class="form-control" 
            type="text" 
            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"> </td>
      </tr>
   </table>
   <div class="form-group"> 
      <button id="btn-read"
         class="btn btn-success btn-lg float-right" 
         type="submit">Start</button> 
	  <output id="attribute"><b>/myNode/myObject/myMeasure:</b> </output>
   </div>
</div>
<iframe id="download_frame" style="display:none;"></iframe>


> Note: For performance reasons, the attributes values are stored every 3s in influxDB, that's why every value changes can't be seen. 

> More information about the data access in [Data access / application](/data_access/data) section.

<script type="text/javascript">
	
	$(document).ready(function () {		
	  var timer = null;
	  
	  $("#btn-test").click(function () {
		var host = $("#hostname").val();
		var user = $("#username").val();
		var pass = $("#password").val();
		if(!host)
			alert("Hostname cannot be empty!");
		else if(!user)
			alert("Username cannot be empty!");
		else if(!pass)
			alert("Password cannot be empty!");
		else{	
			var formData = {};
			$.ajax({
				url : host + "/api/v1/account",
				type: "GET",
				data : formData,
				crossDomain: true,
				headers: {
					"Authorization": "Basic " + btoa(user + ":" + pass)
                },
				success: function(data, textStatus, jqXHR)
				{
					alert("Connection successful!");
				},
				error: function (jqXHR, textStatus, errorThrown)
				{
					alert("Error while trying to connect");
				}
			});
		}
	  });
	  $("#hostname").on("input", function () {		
			$("#swagger_url").text($("#hostname").val() + "/swagger-ui/index.html#/Cors Management/postOrigin").show();
			$("#swagger_url").attr("href", $("#swagger_url").text());
		});
		
	  $("#btn-certs").click(function () {
		var host = $("#hostname").val();
		var user = $("#username").val();
		var pass = $("#password").val();
		var uuid = "";
		
		if(!host)
			alert("Hostname cannot be empty!");
		else if(!user)
			alert("Username cannot be empty!");
		else if(!pass)
			alert("Password cannot be empty!");
		else{	
			var formData = {};
			$.ajax({
				url : host + "/api/v1/endpoints?friendlyName=quickstart",
				type: "POST",
				data : formData,
				crossDomain: true,
				headers: {
					"Authorization": "Basic " + btoa(user + ":" + pass)
                },
				success: function(data, textStatus, jqXHR)
				{
					uuid = data.uuid;
					$("#uuid").val(uuid);
					
					set_properties(host, user, pass, uuid);
				},
				error: function (jqXHR, textStatus, errorThrown)
				{
					alert("Error while creating endpoint");
				}
			});
		}
	  });
		
	  $("#btn-read").click(function () {
		var host = $("#hostname").val();
		var user = $("#username").val();
		var pass = $("#password").val();
		var uuid = $("#uuid").val();
		
		if($("#btn-read").text() === "Start"){
				if(!host)
					alert("Hostname cannot be empty!");
				else if(!user)
					alert("Username cannot be empty!");
				else if(!pass)
					alert("Password cannot be empty!");
				else if(!uuid)
					alert("UUID cannot be empty!");	
				else{
					$("#btn-read").html("Stop");
						timer = setInterval(function(){
						const attr = read_attribute(host, user, pass, uuid + "/myNode/myObject/myMeasure", display_my_measure);						
					}, 3000);					
				}
		}
		else{
			$("#btn-read").html("Start");
			clearInterval(timer);
			timer = null;
		}
	  });
	});
	function read_attribute(host, user, pass, attr, _callback) {
		var formData = {};
			$.ajax({
				url : host + "/api/v1/data/" + attr,
				type: "GET",
				data : formData,
				crossDomain: true,
				headers: {
					"Authorization": "Basic " + btoa(user + ":" + pass)
                },
				success: function(data, textStatus, jqXHR)
				{
					console.log(data);
					_callback(attr, data);
				},
				error: function (jqXHR, textStatus, errorThrown)
				{
					alert("Error while trying to reading data");
				}
			});
    }
	
	function display_my_measure(id, value) {
		console.log(id + ": " + value.value);
		$("#attribute").html("<b>myNode/myObject/myMeasure:</b> " + value.value);
	}
	
	function set_properties(host, user, pass, uuid) {
		var tab = host.replace("http://", "").replace("https://", "").split(":");
		var formData = {
		  "customProperties": {
			"ch.hevs.cloudio.endpoint.hostUri": "ssl://" + tab[0],
			"ch.hevs.cloudio.endpoint.ssl.authorityCert": "file:/C:/Users/.../cloudio-endpoint-java-example/src/main/resources/cloud.io/authority.jks",
			"ch.hevs.cloudio.endpoint.ssl.clientCert": "file:/C:/Users/.../cloudio-endpoint-java-example/src/main/resources/cloud.io/" + uuid + ".p12",
			"ch.hevs.cloudio.endpoint.ssl.verifyHostname": "false"
		  }
		};
		console.log(formData);
		$.ajax({
			url : host + "/api/v1/endpoints/" + uuid + "/provisionToken",
			type: "POST",
			data : JSON.stringify(formData),
			crossDomain: true,
			headers: {
				"Authorization": "Basic " + btoa(user + ":" + pass),
				"Content-Type": "application/json"
			},
			success: function(data, textStatus, jqXHR)
			{
				get_certificates(host, data);
			},
			error: function (jqXHR, textStatus, errorThrown)
			{
				alert("Error while trying to generate certificates");
			}
		});
    }
	
	function get_certificates(host, token){
		
		fetch(host + "/api/v1/provision/" + token + "?propertiesFileName=example", {headers: {"Accept": "application/java-archive"}})
		  .then(resp => resp.blob())
		  .then(blob => {
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.style.display = 'none';
			a.href = url;
			// the filename you want
			a.download = 'quickstart-certificates.jar';
			document.body.appendChild(a);
			a.click();
			window.URL.revokeObjectURL(url);
		  })
		  .catch(() => alert('Error while downloading the certificates!'));
	}

</script>

